{% extends 'dashboard/dashboard_base.html' %}

{% block dashboard_content %}
<section class="space-y-6">
    <div class="flex flex-wrap justify-between items-start gap-4">
        <div>
            <h1 class="text-2xl font-semibold text-slate-900">Reports & Analytics</h1>
            <p class="text-slate-500 text-sm mt-1">Revenue analytics, booking trends, owner performance, and top cars.</p>
        </div>
        <form method="get" class="flex gap-2 flex-wrap bg-white p-2 rounded-xl border border-slate-100">
            <input type="date" name="start_date" value="{{ filters.start_date }}" class="px-3 py-2 rounded-lg border border-slate-200">
            <input type="date" name="end_date" value="{{ filters.end_date }}" class="px-3 py-2 rounded-lg border border-slate-200">
            <button class="px-4 py-2 rounded-lg bg-slate-900 text-white">Apply</button>
        </form>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
        <article class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm"><p class="text-xs text-slate-500">Revenue</p><p class="text-2xl font-semibold">₹{{ summary.revenue|floatformat:2 }}</p></article>
        <article class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm"><p class="text-xs text-slate-500">Bookings</p><p class="text-2xl font-semibold">{{ summary.bookings }}</p></article>
        <article class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm"><p class="text-xs text-slate-500">Completed</p><p class="text-2xl font-semibold">{{ summary.completed_bookings }}</p></article>
        <article class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm"><p class="text-xs text-slate-500">Active Owners</p><p class="text-2xl font-semibold">{{ summary.active_owners }}</p></article>
    </div>

    <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm">
        <h2 class="text-sm font-semibold text-slate-700 mb-3">Booking Trends</h2>
        <canvas id="bookingTrendChart" height="100"></canvas>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
        <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm overflow-x-auto">
            <h2 class="text-sm font-semibold text-slate-700 mb-3">Owner Performance</h2>
            <table class="min-w-full text-sm">
                <thead class="text-slate-500 border-b border-slate-100"><tr><th class="text-left py-2">Owner</th><th class="text-left py-2">Cars</th><th class="text-left py-2">Bookings</th><th class="text-left py-2">Revenue</th></tr></thead>
                <tbody class="divide-y divide-slate-100">
                    {% for owner in owner_performance %}
                    <tr><td class="py-2">{{ owner.username }}</td><td class="py-2">{{ owner.total_cars }}</td><td class="py-2">{{ owner.total_bookings }}</td><td class="py-2">₹{{ owner.total_revenue|default:0|floatformat:2 }}</td></tr>
                    {% empty %}<tr><td colspan="4" class="py-8 text-center text-slate-500">No owner data.</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>

        <div class="bg-white rounded-xl border border-slate-100 p-4 shadow-sm overflow-x-auto">
            <h2 class="text-sm font-semibold text-slate-700 mb-3">Top Performing Cars</h2>
            <table class="min-w-full text-sm">
                <thead class="text-slate-500 border-b border-slate-100"><tr><th class="text-left py-2">Car</th><th class="text-left py-2">Owner</th><th class="text-left py-2">Bookings</th><th class="text-left py-2">Revenue</th></tr></thead>
                <tbody class="divide-y divide-slate-100">
                    {% for car in top_cars %}
                    <tr><td class="py-2">{{ car.name }}</td><td class="py-2">{{ car.owner.username }}</td><td class="py-2">{{ car.total_bookings }}</td><td class="py-2">₹{{ car.total_revenue|default:0|floatformat:2 }}</td></tr>
                    {% empty %}<tr><td colspan="4" class="py-8 text-center text-slate-500">No car performance data.</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

{{ booking_trends.labels|json_script:"trend-labels" }}
{{ booking_trends.data|json_script:"trend-data" }}

<script>
    const trendLabels = JSON.parse(document.getElementById('trend-labels').textContent);
    const trendData = JSON.parse(document.getElementById('trend-data').textContent);
    if (document.getElementById('bookingTrendChart')) {
        new Chart(document.getElementById('bookingTrendChart'), {
            type: 'bar',
            data: {
                labels: trendLabels,
                datasets: [{ label: 'Bookings', data: trendData, backgroundColor: '#0f172a' }]
            },
            options: { plugins: { legend: { display: false } } }
        });
    }
</script>
{% endblock %}
