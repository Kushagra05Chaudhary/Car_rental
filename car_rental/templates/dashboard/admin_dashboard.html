{% extends 'dashboard/dashboard_base.html' %}

{% block dashboard_content %}
<section class="space-y-6">
    <div class="flex flex-wrap justify-between items-start gap-4">
        <div>
            <h1 class="text-2xl sm:text-3xl font-semibold text-slate-900">System Analytics</h1>
            <p class="text-slate-500 mt-1">Operational visibility across users, cars, bookings, and revenue.</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="{% url 'admin_owner_management' %}" class="px-4 py-2 rounded-xl text-sm bg-white border border-slate-200 hover:shadow-sm">Review Owners</a>
            <a href="{% url 'admin_car_list' %}" class="px-4 py-2 rounded-xl text-sm bg-white border border-slate-200 hover:shadow-sm">Moderate Cars</a>
            <a href="{% url 'admin_reports' %}" class="px-4 py-2 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800">Open Reports</a>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Total Users</p><p class="text-2xl font-semibold mt-1">{{ total_users }}</p>
        </article>
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Total Owners</p><p class="text-2xl font-semibold mt-1">{{ total_owners }}</p>
        </article>
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Total Cars</p><p class="text-2xl font-semibold mt-1">{{ total_cars }}</p>
        </article>
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Active Cars</p><p class="text-2xl font-semibold mt-1">{{ active_cars }}</p>
        </article>
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Total Bookings</p><p class="text-2xl font-semibold mt-1">{{ total_bookings }}</p>
        </article>
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Pending Bookings</p><p class="text-2xl font-semibold mt-1">{{ pending_bookings }}</p>
        </article>
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Total Revenue</p><p class="text-2xl font-semibold mt-1">₹{{ total_revenue|floatformat:2 }}</p>
        </article>
        <article class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 hover:shadow-md transition">
            <p class="text-xs text-slate-500">Monthly Revenue</p><p class="text-2xl font-semibold mt-1">₹{{ monthly_revenue|floatformat:2 }}</p>
        </article>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100 p-4">
            <h2 class="text-sm font-semibold text-slate-700 mb-3">Monthly Revenue Trend</h2>
            <canvas id="adminRevenueChart" height="120"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
            <h2 class="text-sm font-semibold text-slate-700 mb-3">Booking Status Mix</h2>
            <canvas id="bookingStatusChart" height="120"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 overflow-x-auto">
        <h2 class="text-sm font-semibold text-slate-700 mb-4">Recent Activities</h2>
        <table class="min-w-full text-sm">
            <thead>
                <tr class="text-left text-slate-500 border-b border-slate-100">
                    <th class="py-2">Type</th>
                    <th class="py-2">Details</th>
                    <th class="py-2">Status</th>
                    <th class="py-2">Amount</th>
                    <th class="py-2">Time</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for item in recent_activities %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="py-2">{{ item.type }}</td>
                    <td class="py-2">{{ item.title }}</td>
                    <td class="py-2"><span class="px-2 py-1 rounded-full text-xs bg-slate-100">{{ item.status|title }}</span></td>
                    <td class="py-2">{% if item.amount %}₹{{ item.amount|floatformat:2 }}{% else %}-{% endif %}</td>
                    <td class="py-2 text-slate-500">{{ item.timestamp|date:"M d, Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="py-8 text-center text-slate-500">No activities available yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>

{{ revenue_chart.labels|json_script:"revenue-labels" }}
{{ revenue_chart.data|json_script:"revenue-data" }}
{{ booking_status_chart.labels|json_script:"booking-labels" }}
{{ booking_status_chart.data|json_script:"booking-data" }}

<script>
    const revenueLabels = JSON.parse(document.getElementById('revenue-labels').textContent);
    const revenueData = JSON.parse(document.getElementById('revenue-data').textContent);
    const bookingLabels = JSON.parse(document.getElementById('booking-labels').textContent);
    const bookingData = JSON.parse(document.getElementById('booking-data').textContent);

    const revenueCtx = document.getElementById('adminRevenueChart');
    if (revenueCtx) {
        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Revenue',
                    data: revenueData,
                    borderColor: '#0f172a',
                    backgroundColor: 'rgba(15,23,42,0.1)',
                    fill: true,
                    tension: 0.35
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    const bookingCtx = document.getElementById('bookingStatusChart');
    if (bookingCtx) {
        new Chart(bookingCtx, {
            type: 'pie',
            data: {
                labels: bookingLabels,
                datasets: [{
                    data: bookingData,
                    backgroundColor: ['#0f172a', '#3b82f6', '#22c55e', '#eab308', '#ef4444']
                }]
            },
            options: { responsive: true }
        });
    }
</script>

{% endblock %}