{% extends 'dashboard/dashboard_base.html' %}

{% block dashboard_content %}
<section class="space-y-6" x-data="{ expanded: null }">
    <div>
        <h1 class="text-2xl font-semibold text-slate-900">Booking Control</h1>
        <p class="text-slate-500 text-sm mt-1">Monitor all bookings, cancel records, and trigger refunds.</p>
    </div>

    <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-3 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
        <input type="text" name="q" value="{{ filters.q }}" placeholder="Search user, owner or car" class="px-3 py-2 rounded-lg border border-slate-200">
        <select name="status" class="px-3 py-2 rounded-lg border border-slate-200">
            <option value="">All Statuses</option>
            <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="confirmed" {% if filters.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
            <option value="completed" {% if filters.status == 'completed' %}selected{% endif %}>Completed</option>
            <option value="cancelled" {% if filters.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            <option value="rejected" {% if filters.status == 'rejected' %}selected{% endif %}>Rejected</option>
        </select>
        <input type="date" name="start_date" value="{{ filters.start_date }}" class="px-3 py-2 rounded-lg border border-slate-200">
        <input type="date" name="end_date" value="{{ filters.end_date }}" class="px-3 py-2 rounded-lg border border-slate-200">
        <button class="px-3 py-2 rounded-lg bg-slate-900 text-white">Apply</button>
    </form>

    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-500">
                <tr>
                    <th class="px-4 py-3 text-left">Booking</th>
                    <th class="px-4 py-3 text-left">Renter</th>
                    <th class="px-4 py-3 text-left">Car</th>
                    <th class="px-4 py-3 text-left">Status</th>
                    <th class="px-4 py-3 text-left">Amount</th>
                    <th class="px-4 py-3 text-left">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for booking in bookings %}
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3">#{{ booking.id }}</td>
                    <td class="px-4 py-3">{{ booking.user.username }}</td>
                    <td class="px-4 py-3">{{ booking.car.name }}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs bg-slate-100">{{ booking.status|title }}</span></td>
                    <td class="px-4 py-3">₹{{ booking.total_price }}</td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-2">
                            <button @click="expanded = expanded === {{ booking.id }} ? null : {{ booking.id }}" class="px-2 py-1 rounded-lg border border-slate-200">Details</button>
                            {% if booking.status != 'cancelled' and booking.status != 'completed' %}
                            <form method="post" action="{% url 'admin_cancel_booking' booking.id %}">{% csrf_token %}<button class="px-2 py-1 rounded-lg bg-red-600 text-white">Cancel</button></form>
                            {% endif %}
                            {% if booking.payment and booking.payment.status != 'refunded' %}
                            <form method="post" action="{% url 'admin_refund_booking' booking.id %}">{% csrf_token %}<button class="px-2 py-1 rounded-lg bg-blue-600 text-white">Refund</button></form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                <tr x-show="expanded === {{ booking.id }}" style="display:none;" class="bg-slate-50">
                    <td colspan="6" class="px-4 py-3 text-xs text-slate-600">
                        Owner: {{ booking.car.owner.username }} • Date: {{ booking.start_date }} to {{ booking.end_date }} • Created: {{ booking.created_at|date:'M d, Y H:i' }}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="px-4 py-10 text-center text-slate-500">No bookings found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
